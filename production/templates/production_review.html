<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Production - Categories</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <a href="/" class="home-button">← Home</a>
  <h1>Categories</h1>
  {% if built_at %}
    <p><small>Built at: {{ built_at }}</small></p>
  {% endif %}

  {% if categories %}
    {% for label, items in categories.items() %}
      <div class="source">
        <h2>{{ label }}</h2>
        {% if items %}
          {% for a in items %}
            {# hearing = has time in timestamp like YYYY-MM-DDTHH:MM #}
            {% set is_hearing = 'T' in (a.date or '') %}

            <div class="article" style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <span class="date">{{ a.date | pretty_date(is_hearing) }}</span> -
                <a href="{{ a.url }}" target="_blank">{{ a.title }}</a>
                {% if a.committee %}<span class="committee">&nbsp;• {{ a.committee }}</span>{% endif %}
                <span class="origin">&nbsp;• {{ a.source|capitalize }}</span>
              </div>

              {% if is_hearing %}
                <div class="addevent-controls">
                  <button
                    type="button"
                    class="addevent-btn"
                    data-url="{{ a.url }}"
                    data-id="{{ a.id }}"
                    aria-label="Add to calendar via AddEvent"
                  >
                    <span class="btn-label">AddEvent</span>
                    <span class="spinner" aria-hidden="true"></span>
                  </button>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p><em>No items in this category.</em></p>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p><em>No categories available.</em></p>
  {% endif %}

  <div style="text-align:center; margin-top: 1.5rem;">
    <a href="{{ url_for('production.production_categorize') }}" style="text-decoration:none;">
      <button type="button">← Back to Staging</button>
    </a>

    <a class="export-btn" href="{{ url_for('production.production_export_categories_pdf') }}" style="text-decoration:none; margin-left:.5rem;">
      <button type="button">Export PDF</button>
    </a>
  </div>

  <script>
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.addevent-btn');
    if (!btn) return;

    if (btn.classList.contains('done')) {
      const href = btn.dataset.href || "https://app.addevent.com/calendars/GT179952";
      window.open(href, "_blank", "noopener");
      return;
    }

    const wrap = btn.closest('.addevent-controls');
    const url = btn.dataset.url;
    if (!url || btn.disabled) return;

    btn.classList.add('loading');
    btn.disabled = true;

    try {
      const res = await fetch("{{ url_for('production.production_addevent') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed to create event");

      btn.classList.remove('loading', 'error');
      btn.classList.add('done');
      btn.disabled = false; 
      btn.querySelector('.btn-label').textContent = 'Added';
      btn.dataset.href = "https://app.addevent.com/calendars/GT179952";
    } catch (err) {
      btn.classList.remove('loading');
      btn.classList.add('error');
      btn.disabled = false;
      const label = btn.querySelector('.btn-label');
      if (label) label.textContent = 'Retry';
      console.error(err);
    }
  });
  </script>
</body>
</html>
